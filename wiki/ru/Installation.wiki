#summary installation
#labels Phase-Deploy,Featured

Я предлагаю два относительно простых способа для запуска Apache внутри jail: патч для исходных текстов Apache и динамически загружаемый модуль.
Патч более предпочтителен, так как лишён многих недостатков модуля, например, он отлично "понмает" SIGHUP.
Как патч, так и модуль распространяются в виде каркасов(skeleton) порта.

= Details =
===Инструкции по установке Apache с патчем:===

Загрузите каркас(skeleton) порта: {{{fetch http://mod-jail.googlecode.com/files/port-apache13-1.3.41_1.tgz}}}.
Это обычный порт для FreeBSD с патчем для поддержки (2) jail.


Дальше всё как обычно:
Распаковываем содержимое архива: {{{tar -xzvf port-apache13-1.3.41_1.tgz}}}.

Собираем и устанавливаем порт: {{{cd apache13 && make all install clean}}}. Для установки необходимы права root.

Ну что же, Apache установлен, осталось внести изменения в конфигурационный файл.
В принципе, для запуска Apache в jail достаточно добавить одну строчку в httpd.conf: `JailDir "/usr/local/www"`,
но на практике необходимо ещё подравить пути с учётом, что корневая директория теперь `JailDir`.
Есть и другие параметры конфигурации: `JailAddress`, `JailHostname` and `JailSecurelevel`, их значения по умолчанию закомментированы,
так как подходят для большинства пользователей:
{{{
JailDir "/usr/local/www"
# Default values
# IP address of jail prison
#JailAddress "127.0.0.1"
# hostname for jail prison
#JailHostname "localhost"
# securelevel(7) inside jail prison
#JailSecurelevel 3
}}}
Параметр `JailAddress` определяет IP-адрес для сокетов созданных внутри jail,
значение по умолчанию блокирует скриптам возможность устанавливать сетевые соединения вне localhost'а.


Запускаем Apache: `apachectl start`. По идее, всё должно работать. Каждый потомок Apache запускается в своём собственном окружении jail. Jail'ы можно увидеть коммандой `jls`:
{{{
# jls
   JID  IP Address      Hostname                      Path
    13  127.0.0.1       localhost                     /usr/local/www
    14  127.0.0.1       localhost                     /usr/local/www
    15  127.0.0.1       localhost                     /usr/local/www
    16  127.0.0.1       localhost                     /usr/local/www
    17  127.0.0.1       localhost                     /usr/local/www
    18  127.0.0.1       localhost                     /usr/local/www
}}}

===Инструкции по установке модуля:===
Для модуля есть официальный порт, но бинарный пакет скомпилирован под Apache 1.3, вы можете просто установить его без компиляции коммандой: `# pkg_add -r mod_jail`.
Модуль для Apache2 придётся собрать из портов: `# cd /usr/ports/www/mod_jail && make all install clean`.

Заметка: Для установки портов необходимы права root.

====Apache:====
Необходимо отредактировать кофигурационный файл Apache, можно вос пользоваться _httpd.conf.add_ в качестве примера.
Если вы используете Apache версии 1.3.хх убедитесь, что строка `AddModule mod_jail.so` идёт сразу за `ClearModuleList`,
для Apache2 достаточно просто `LoadModule libexec/apache2/mod_jail2.so`.
{{{
LoadModule jail_module        libexec/apache/mod_jail.so
# ...

ClearModuleList
AddModule mod_jail.c
# ...
#
<IfModule mod_jail.c>
        jail_rootdir            "/usr/local/www"
        jail_hostname           "www.localhost.net"
        jail_address            192.168.0.1
        # recommended value for securelevel
        jail_scrlevel           3
</IfModule>
# необходимо выставить значения для всёх параметров
}}}

====Make it all working:====
Перезапускаем Apache: `apachectl stop; apachectl start`. По идее, всё должно работать. Jail можно увидеть коммандоё `jls`:
{{{
# jls
 JID  IP Address      Hostname                      Path
  50  192.168.0.1     www.localhost.net             /usr/local/www
}}}

В FreeBSD-8.0 изменился API для работы с jail, новые версии *mod_jail* и *jail patch* поддерживают как "старый" API, так и новый (JAIL API v2).

===Проверка того, что скрипты CGI выполняются в изолированном окружении:===
{{{
<?php
chdir('/');
echo "Current dir is `", getcwd(), "'<br />";

$dir_handle = @opendir('.') or die("Unable to open current dir");
while ($file = readdir($dir_handle)) 
{
   echo "$file<br/>";
}
closedir($dir_handle);

?>
}}}

Этот скрипт должен вывести листинг корневой директории процесса, т.е.`JailDir`.
